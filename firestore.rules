rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the store
    function isStoreOwner(storeId) {
      return isAuthenticated() && request.auth.uid == storeId;
    }
    
    // Allow authenticated users to create their own store document
    match /stores/{storeId} {
      allow read: if isStoreOwner(storeId);
      allow write: if isStoreOwner(storeId);
      
      // Products collection - users can only CRUD their own store's products
      match /products/{productId} {
        allow read, write: if isStoreOwner(storeId);
      }
      
      // Customers collection - users can only CRUD their own store's customers
      match /customers/{customerId} {
        allow read, write: if isStoreOwner(storeId);
      }
      
      // Transactions collection - users can only CRUD their own store's transactions
      match /transactions/{transactionId} {
        allow create: if isStoreOwner(storeId) 
                    && request.resource.data.type in ['credit', 'payment'];
        allow read: if isStoreOwner(storeId);
        // Transactions are immutable - cannot be updated or deleted
        allow update, delete: if false;
      }
    }
  }
}
